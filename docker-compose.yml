services:
  # ─────────────────────────────────────────────
  # PicoClaw Agent (one-shot query)
  #   docker compose run --rm picoclaw-agent -m "Hello"
  # ─────────────────────────────────────────────
  picoclaw-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-agent
    profiles:
      - agent
    # Uncomment to access host network; leave commented unless needed.
    #extra_hosts:
    #  - "host.docker.internal:host-gateway"
    volumes:
      - ./config/config.json:/home/picoclaw/.picoclaw/config.json:ro
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    entrypoint: ["picoclaw", "agent"]
    stdin_open: true
    tty: true

  # ─────────────────────────────────────────────
  # PicoClaw Gateway (Long-running Bot)
  #   docker compose up picoclaw-gateway
  # ─────────────────────────────────────────────
  picoclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-gateway
    restart: unless-stopped
    volumes:
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -eu
        require_env() {
          key="$$1"
          value="$$2"
          if [ -z "$$value" ]; then
            echo "FATAL: missing required env var: $$key" >&2
            exit 1
          fi
        }

        require_env PICOCLAW_PROVIDERS_OPENROUTER_API_KEY "$${PICOCLAW_PROVIDERS_OPENROUTER_API_KEY:-}"
        require_env PICOCLAW_CHANNELS_TELEGRAM_TOKEN "$${PICOCLAW_CHANNELS_TELEGRAM_TOKEN:-}"
        require_env COOLIFY_API_URL "$${COOLIFY_API_URL:-}"
        require_env COOLIFY_API_TOKEN "$${COOLIFY_API_TOKEN:-}"

        [ -n "$${MAXEXTRACT_RUNTIME_BTC5M_URL:-}" ] || echo "WARN: optional env var not set: MAXEXTRACT_RUNTIME_BTC5M_URL" >&2
        [ -n "$${MAXEXTRACT_RUNTIME_BTC15M_URL:-}" ] || echo "WARN: optional env var not set: MAXEXTRACT_RUNTIME_BTC15M_URL" >&2
        [ -n "$${MAXEXTRACT_RUNTIME_ETH15M_URL:-}" ] || echo "WARN: optional env var not set: MAXEXTRACT_RUNTIME_ETH15M_URL" >&2
        [ -n "$${MAXEXTRACT_RECORDER_5M_URL:-}" ] || echo "WARN: optional env var not set: MAXEXTRACT_RECORDER_5M_URL" >&2
        [ -n "$${MAXEXTRACT_RECORDER_15M_URL:-}" ] || echo "WARN: optional env var not set: MAXEXTRACT_RECORDER_15M_URL" >&2
        [ -n "$${MAXEXTRACT_CROSS_ARB_URL:-}" ] || echo "WARN: optional env var not set: MAXEXTRACT_CROSS_ARB_URL" >&2

        MN="$${PICOCLAW_AGENTS_DEFAULTS_MODEL:-openrouter-auto}"
        MM="$${PICOCLAW_PROVIDERS_OPENROUTER_MODEL:-openrouter/minimax/minimax-m2.5}"
        MT="$${PICOCLAW_AGENTS_DEFAULTS_MAX_TOKENS:-8192}"
        TP="$${PICOCLAW_AGENTS_DEFAULTS_TEMPERATURE:-0.7}"
        MI="$${PICOCLAW_AGENTS_DEFAULTS_MAX_TOOL_ITERATIONS:-20}"
        RW="$${PICOCLAW_AGENTS_DEFAULTS_RESTRICT_TO_WORKSPACE:-true}"
        cat > /home/picoclaw/.picoclaw/config.json << CFGEOF
        {"agents":{"defaults":{"workspace":"~/.picoclaw/workspace","restrict_to_workspace":$${RW},"model":"$${MN}","max_tokens":$${MT},"temperature":$${TP},"max_tool_iterations":$${MI}}},"model_list":[{"model_name":"$${MN}","model":"$${MM}","api_key":"$${PICOCLAW_PROVIDERS_OPENROUTER_API_KEY}","api_base":"https://openrouter.ai/api/v1"}],"tools":{"web":{"duckduckgo":{"enabled":true,"max_results":5},"brave":{"enabled":false},"tavily":{"enabled":false}},"exec":{"deny_patterns":[]}},"heartbeat":{"enabled":true,"interval":60},"gateway":{"host":"0.0.0.0","port":18790}}
        CFGEOF
        cp -r /opt/picoclaw-skills/* /home/picoclaw/.picoclaw/workspace/skills/ 2>/dev/null || true
        exec picoclaw gateway

volumes:
  picoclaw-workspace:
