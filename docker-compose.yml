services:
  # ─────────────────────────────────────────────
  # PicoClaw Agent (one-shot query)
  #   docker compose run --rm picoclaw-agent -m "Hello"
  # ─────────────────────────────────────────────
  picoclaw-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-agent
    profiles:
      - agent
    # Uncomment to access host network; leave commented unless needed.
    #extra_hosts:
    #  - "host.docker.internal:host-gateway"
    volumes:
      - ./config/config.json:/home/picoclaw/.picoclaw/config.json:ro
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    entrypoint: ["picoclaw", "agent"]
    stdin_open: true
    tty: true

  # ─────────────────────────────────────────────
  # PicoClaw Gateway (Long-running Bot)
  #   docker compose up picoclaw-gateway
  # ─────────────────────────────────────────────
  picoclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-gateway
    restart: unless-stopped
    volumes:
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cat > /home/picoclaw/.picoclaw/config.json << CFGEOF
        {"agents":{"defaults":{"workspace":"~/.picoclaw/workspace","restrict_to_workspace":true,"model":"openrouter-auto","max_tokens":8192,"temperature":0.7,"max_tool_iterations":20}},"model_list":[{"model_name":"openrouter-auto","model":"openrouter/minimax/minimax-m2.5","api_key":"$${PICOCLAW_PROVIDERS_OPENROUTER_API_KEY}","api_base":"https://openrouter.ai/api/v1"}],"tools":{"web":{"duckduckgo":{"enabled":true,"max_results":5},"brave":{"enabled":false},"tavily":{"enabled":false}}},"heartbeat":{"enabled":true,"interval":60},"gateway":{"host":"0.0.0.0","port":18790}}
        CFGEOF
        exec picoclaw gateway

volumes:
  picoclaw-workspace:
